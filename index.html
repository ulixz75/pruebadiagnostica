<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NABORI Corp - Prueba Diagnóstica de Matemáticas</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      /* --- Reseteo y Estilos Globales --- */
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: "Poppins", "Roboto", sans-serif;
        background-color: #f8fafc;
        color: #1e293b;
        line-height: 1.6;
      }

      #app {
        max-width: 900px;
        margin: 0 auto;
        background-color: #ffffff;
        min-height: 100vh;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        position: relative;
      }

      .hidden {
        display: none !important;
      }

      /* --- Cabeceras --- */
      .app-header {
        text-align: center;
        padding: 1.5rem;
        background: linear-gradient(135deg, #2563eb, #1d4ed8);
        color: white;
      }

      .app-header-exam {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.5rem;
        background: #ffffff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .logo {
        max-width: 200px;
      }

      .logo-small {
        max-width: 80px;
      }

      .app-header h1 {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 0;
      }

      /* --- Pantalla de Bienvenida --- */
      #welcome-screen {
        padding: 0 1.5rem 2rem;
      }

      .welcome-main {
        padding: 2rem 1rem;
      }

      .welcome-main h2 {
        color: #2563eb;
        margin-bottom: 1.5rem;
        text-align: center;
        font-size: 1.8rem;
      }

      .instructions-container {
        background-color: #ffffff;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        border: 1px solid #e2e8f0;
      }

      .instructions-list {
        list-style: none;
      }

      .instructions-list li {
        padding: 0.75rem 0;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        align-items: flex-start;
      }

      .instructions-list li:last-child {
        border-bottom: none;
      }

      .instructions-list li i {
        color: #2563eb;
        margin-right: 0.75rem;
        margin-top: 0.25rem;
        font-size: 1.2rem;
      }

      .student-info {
        background-color: #ffffff;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        border: 1px solid #e2e8f0;
      }

      .alert {
        padding: 0.75rem;
        border-radius: 4px;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        background-color: #dbeafe;
        color: #1d4ed8;
      }

      .alert i {
        margin-right: 0.75rem;
        font-size: 1.2rem;
      }

      .input-group {
        margin-bottom: 1.25rem;
      }

      .input-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: #1e293b;
      }

      input[type="text"],
      input[type="date"],
      input[type="email"] {
        width: 100%;
        padding: 0.875rem 1rem;
        border: 1px solid #cbd5e1;
        border-radius: 4px;
        font-family: "Poppins", sans-serif;
        font-size: 1rem;
        transition: border-color 0.2s;
      }

      input:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
      }

      .btn-container {
        text-align: center;
        margin-top: 2rem;
      }

      /* --- Botones --- */
      button {
        background: linear-gradient(to right, #2563eb, #4338ca);
        color: white;
        border: none;
        padding: 1rem 2rem;
        font-size: 1.1rem;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      }

      button:active {
        transform: translateY(0);
      }

      button i {
        margin-right: 0.5rem;
      }

      button:disabled {
        background: #94a3b8;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      /* --- Pantalla del Examen --- */
      #exam-screen {
        padding-bottom: 2rem;
      }

      #timer-container {
        background: linear-gradient(to right, #2563eb, #4338ca);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-width: 120px;
        margin-left: auto;
      }

      #timer-label {
        font-size: 0.75rem;
        opacity: 0.9;
      }

      #timer {
        font-size: 1.25rem;
        font-weight: 700;
      }

      #section-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #2563eb;
      }

      #quiz-form {
        padding: 1rem 1.5rem;
      }

      .pagination-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 1.5rem;
        padding: 1rem;
        background-color: #ffffff;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }

      .pagination-info {
        font-weight: 500;
        color: #64748b;
      }

      .question-block {
        background-color: #ffffff;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        border: 1px solid #e2e8f0;
        transition: all 0.2s;
      }

      .question-block:focus-within {
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      }

      .question-text {
        font-size: 1.1rem;
        font-weight: 500;
        margin-bottom: 1.25rem;
        color: #1e293b;
        line-height: 1.5;
      }

      .question-number {
        display: inline-block;
        background-color: #2563eb;
        color: white;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        text-align: center;
        line-height: 28px;
        margin-right: 0.5rem;
        font-size: 0.9rem;
      }

      .options-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 0.75rem;
      }

      @media (min-width: 640px) {
        .options-grid {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      .option {
        display: flex;
        align-items: center;
        padding: 1rem;
        border: 1px solid #cbd5e1;
        border-radius: 4px;
        background-color: #ffffff;
        transition: all 0.2s;
        cursor: pointer;
      }

      .option:hover {
        border-color: #2563eb;
        background-color: #f1f5f9;
      }

      .option input[type="radio"] {
        margin-right: 1rem;
        width: 20px;
        height: 20px;
        cursor: pointer;
      }

      .option label {
        flex-grow: 1;
        cursor: pointer;
        font-weight: 400;
      }

      .navigation-buttons {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin-top: 2rem;
      }

      .btn-secondary {
        background: linear-gradient(to right, #64748b, #475569);
      }

      /* --- Botón flotante para modal --- */
      .open-modal-btn {
        position: fixed;
        bottom: 30px;
        left: 30px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #4f46e5, #7c3aed);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        cursor: pointer;
        z-index: 1000;
        transition: all 0.3s ease;
        font-size: 24px;
      }

      .open-modal-btn:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
      }

      /* --- Modal --- */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }

      .modal-overlay.active {
        opacity: 1;
        visibility: visible;
      }

      .modal-content {
        width: 90%;
        max-width: 1200px;
        height: 80vh;
        background-color: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
        transform: translateY(50px);
        transition: transform 0.4s ease;
        display: flex;
        flex-direction: column;
      }

      .modal-overlay.active .modal-content {
        transform: translateY(0);
      }

      .modal-header {
        padding: 15px 20px;
        background: linear-gradient(to right, #4f46e5, #7c3aed);
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-title {
        font-size: 1.2rem;
        font-weight: 600;
      }

      .close-modal {
        background: none;
        border: none;
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
        transition: transform 0.2s;
      }

      .close-modal:hover {
        transform: scale(1.2);
      }

      .modal-body {
        flex: 1;
        overflow: hidden;
      }

      .modal-iframe {
        width: 100%;
        height: 100%;
        border: none;
      }

      /* Responsive design para el modal */
      @media (max-width: 768px) {
        .modal-content {
          width: 95%;
          height: 70vh;
        }

        .open-modal-btn {
          bottom: 20px;
          left: 20px;
          width: 50px;
          height: 50px;
          font-size: 20px;
        }
      }

      @media (max-width: 480px) {
        .modal-content {
          width: 100%;
          height: 90vh;
          border-radius: 0;
        }

        .app-header-exam {
          flex-direction: column;
          gap: 1rem;
          text-align: center;
        }

        #timer-container {
          margin-left: 0;
        }
      }

      /* --- Pantalla de Resultados --- */
      #results-screen {
        padding: 0 1.5rem 2rem;
      }

      .results-main {
        padding: 1.5rem 0;
      }

      #summary-container {
        background-color: #ffffff;
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 2rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        border: 1px solid #e2e8f0;
      }

      #results-breakdown {
        margin-top: 2rem;
      }

      .student-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
      }

      .detail-item {
        display: flex;
        flex-direction: column;
      }

      .detail-label {
        font-size: 0.875rem;
        color: #64748b;
        margin-bottom: 0.25rem;
      }

      .detail-value {
        font-weight: 500;
        color: #1e293b;
      }

      #score-container {
        background: linear-gradient(135deg, #2563eb, #4338ca);
        color: white;
        padding: 1.5rem;
        border-radius: 8px;
        text-align: center;
        margin-top: 1.5rem;
      }

      #score,
      #percentage {
        font-size: 2rem;
        font-weight: 700;
        display: block;
        margin-top: 0.5rem;
      }

      .result-item {
        background-color: #ffffff;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        border: 1px solid #e2e8f0;
        border-left: 4px solid #2563eb;
      }

      .result-item.incorrect {
        border-left-color: #ef4444;
      }

      .result-item p {
        margin-bottom: 0.75rem;
        line-height: 1.6;
      }

      .user-answer.incorrect-text {
        color: #ef4444;
        font-weight: 500;
      }

      .correct-answer-text {
        color: #2563eb;
        font-weight: 500;
      }

      .explanation {
        margin-top: 1rem;
        padding: 1rem;
        background-color: #f1f5f9;
        border-radius: 4px;
        color: #64748b;
        border-left: 3px solid #3b82f6;
      }

      .results-actions {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
      }

      /* Botón para subir */
      .floating-btn {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: linear-gradient(135deg, #2563eb, #4338ca);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        cursor: pointer;
        z-index: 1000;
        transition: all 0.3s ease;
        font-size: 1.2rem;
      }

      .floating-btn:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
      }

      /* Progress bar */
      .progress-container {
        width: 100%;
        height: 8px;
        background-color: #e2e8f0;
        border-radius: 4px;
        margin: 1rem 0;
        overflow: hidden;
      }

      .progress-bar {
        height: 100%;
        background: linear-gradient(to right, #2563eb, #4338ca);
        border-radius: 4px;
        transition: width 0.3s ease;
      }

      /* Alertas */
      .alert-info {
        background-color: #dbeafe;
        color: #1d4ed8;
        border-left: 4px solid #1d4ed8;
      }

      /* Impresión */
      @media print {
        .app-header,
        .pagination-controls,
        button,
        .floating-btn,
        .open-modal-btn {
          display: none !important;
        }

        .result-item {
          break-inside: avoid;
          page-break-inside: avoid;
        }
      }
    </style>
  </head>

  <body>
    <div id="app">
      <!-- Cabecera -->
      <header class="app-header">
        <img
          src="https://static.wixstatic.com/media/af3a4a_94d04bcd8f70410eb6df620852e3cbbd~mv2.png"
          alt="Logo NABORI Corp"
          class="logo"
        />
        <h1>Prueba Diagnóstica SAT/College Board de Matemáticas</h1>
      </header>

      <!-- Pantalla de Bienvenida -->
      <div id="welcome-screen">
        <div class="welcome-main">
          <h2>Instrucciones Generales</h2>
          <div class="instructions-container">
            <ul class="instructions-list">
              <li>
                <i class="fas fa-info-circle"></i>
                <div>
                  Esta prueba está dividida en <strong>DOS SECCIONES</strong>.
                </div>
              </li>
              <li>
                <i class="fas fa-clock"></i>
                <div>
                  <strong>Sección I:</strong> Temas del SAT College Board (48
                  preguntas). Tiempo: 60 minutos.
                </div>
              </li>
              <li>
                <i class="fas fa-clock"></i>
                <div>
                  <strong>Sección II:</strong> Conceptos Matemáticos Básicos (20
                  preguntas). Tiempo: 30 minutos adicionales.
                </div>
              </li>
              <li>
                <i class="fas fa-check-circle"></i>
                <div>Selecciona la mejor respuesta para cada pregunta.</div>
              </li>
              <li>
                <i class="fas fa-save"></i>
                <div>Tu progreso se guardará en este navegador.</div>
              </li>
              <li>
                <i class="fas fa-chart-line"></i>
                <div>
                  Al finalizar, recibirás un reporte detallado con tus
                  resultados.
                </div>
              </li>
            </ul>
          </div>

          <div class="student-info">
            <div class="alert alert-info">
              <i class="fas fa-info-circle"></i>
              Completa tu información para comenzar
            </div>

            <div class="input-group">
              <label for="student-name">
                <i class="fas fa-user"></i> Nombre completo
              </label>
              <input
                type="text"
                id="student-name"
                placeholder="Escribe tu nombre completo"
              />
            </div>

            <div class="input-group">
              <label for="parent-email">
                <i class="fas fa-envelope"></i> Email del padre/encargado
              </label>
              <input
                type="email"
                id="parent-email"
                placeholder="Email del padre/encargado"
              />
            </div>

            <div class="input-group">
              <label for="exam-date">
                <i class="fas fa-calendar"></i> Fecha de examen
              </label>
              <input type="date" id="exam-date" />
            </div>
          </div>

          <div class="btn-container">
            <button id="start-exam-btn">
              <i class="fas fa-play-circle"></i> Iniciar Sección I
            </button>
          </div>
        </div>
      </div>

      <!-- Pantalla del Examen -->
      <div id="exam-screen" class="hidden">
        <header class="app-header-exam">
          <img
            src="https://static.wixstatic.com/media/af3a4a_d429ad2cdddc45338bf5cb5ad1d08127~mv2.jpg"
            alt="Logo NABORI Corp"
            class="logo-small"
          />
          <div id="section-title"></div>
          <div id="timer-container">
            <span id="timer-label">Tiempo Restante:</span>
            <span id="timer">00:00</span>
          </div>
        </header>
        <main>
          <div class="pagination-controls">
            <button id="prev-page-btn" class="page-btn btn-secondary">
              <i class="fas fa-arrow-left"></i> Anterior
            </button>
            <span class="pagination-info" id="pagination-info"
              >Página 1 de 5</span
            >
            <button id="next-page-btn" class="page-btn">
              Siguiente <i class="fas fa-arrow-right"></i>
            </button>
          </div>

          <div id="quiz-form">
            <div id="questions-container"></div>
          </div>

          <div class="pagination-controls">
            <button id="prev-page-btn-bottom" class="page-btn btn-secondary">
              <i class="fas fa-arrow-left"></i> Anterior
            </button>
            <span class="pagination-info" id="pagination-info-bottom"
              >Página 1 de 5</span
            >
            <button id="next-page-btn-bottom" class="page-btn">
              Siguiente <i class="fas fa-arrow-right"></i>
            </button>
          </div>

          <div class="navigation-buttons">
            <button id="next-section-btn" class="hidden btn-secondary">
              <i class="fas fa-arrow-right"></i> Ir a la Siguiente Sección
            </button>
            <button id="finish-exam-btn" class="hidden">
              <i class="fas fa-flag-checkered"></i> Finalizar Examen
            </button>
          </div>
        </main>
      </div>

      <!-- Pantalla de Resultados -->
      <div id="results-screen" class="hidden">
        <header class="app-header">
          <img
            src="https://static.wixstatic.com/media/af3a4a_d429ad2cdddc45338bf5cb5ad1d08127~mv2.jpg"
            alt="Logo NABORI Corp"
            class="logo"
          />
          <h1>Reporte de Resultados</h1>
        </header>
        <main class="results-main">
          <div id="summary-container">
            <h3>Resumen del Desempeño</h3>
            <div class="student-details">
              <div class="detail-item">
                <span class="detail-label">Estudiante:</span>
                <span class="detail-value" id="student-name-result">-</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Email del Padre/Encargado:</span>
                <span class="detail-value" id="parent-email-result">-</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Fecha:</span>
                <span class="detail-value" id="exam-date-result">-</span>
              </div>
            </div>
            <div id="score-container">
              <p>Puntuación:</p>
              <span id="score">-</span>
              <p>Porcentaje de Aciertos:</p>
              <span id="percentage">-</span>
            </div>
          </div>

          <div class="progress-bar-container">
            <div class="progress-bar" id="progress-bar"></div>
          </div>

          <div id="results-breakdown">
            <h3>Desglose de Respuestas</h3>
          </div>

          <div class="results-actions">
            <button id="download-send-btn">
              <i class="fas fa-download"></i> Descargar Reporte en PDF y Enviar
            </button>
            <button id="print-results-btn">
              <i class="fas fa-print"></i> Imprimir Resultados
            </button>
          </div>
        </main>
      </div>

      <!-- Botón flotante para abrir modal -->
      <div class="open-modal-btn" id="openModalBtn">
        <i
          class="fa-regular fa-circle-question fa-2xl"
          style="color: #ffd43b"
        ></i>
      </div>

      <!-- Modal para mostrar página web -->
      <div class="modal-overlay" id="modalOverlay">
        <div class="modal-content">
          <div class="modal-header">
            <div class="modal-title">Portal NABORI Corp</div>
            <button class="close-modal" id="closeModalBtn">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="modal-body">
            <iframe
              class="modal-iframe"
              id="modalIframe"
              src="https://tutor-ia-escolar.web.app/"
              title="Portal NABORI Corp"
            ></iframe>
          </div>
        </div>
      </div>

      <!-- Botón flotante para subir -->
      <div class="floating-btn" id="scrollToTop">
        <i class="fas fa-arrow-up"></i>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script>
      // Inicializar EmailJS
      emailjs.init("DBEJGOx8i0f087iB6");

      // Variables de estado
      let currentSection = "I";
      let currentPage = 1;
      const questionsPerPage = 10;
      let userAnswers = {};
      let timeRemaining = 0;
      let timerInterval;

      // Datos del examen
      const examData = [
        // Sección I (preguntas 1-48)
        {
          id: 1,
          section: "I",
          category: "A. ÁLGEBRA",
          question: "Si x + 5 = 12, entonces x =",
          options: { a: "5", b: "7", c: "17", d: "12" },
          correct: "b",
          explanation: "x = 12 - 5",
        },
        {
          id: 2,
          section: "I",
          category: "A. ÁLGEBRA",
          question: "¿Cuál es el valor de y cuando 3y - 6 = 15?",
          options: { a: "3", b: "5", c: "7", d: "9" },
          correct: "c",
          explanation: "3y = 21, y = 7",
        },
        // ... (todas las preguntas de la Sección I)
        {
          id: 48,
          section: "I",
          category: "D. GEOMETRÍA Y TRIGONOMETRÍA",
          question:
            "En el triángulo rectángulo con catetos 6 y 8, la hipotenusa es:",
          options: { a: "8", b: "10", c: "12", d: "14" },
          correct: "b",
          explanation:
            "Usando el teorema de Pitágoras: 6² + 8² = 36 + 64 = 100. √100 = 10",
        },

        // Sección II (preguntas 49-68)
        {
          id: 49,
          section: "II",
          category: "E. OPERACIONES BÁSICAS",
          question: "3/4 + 1/2 =",
          options: { a: "4/6", b: "5/4", c: "6/12", d: "5/7" },
          correct: "b",
          explanation: "3/4 + 2/4 = 5/4",
        },
        {
          id: 50,
          section: "II",
          category: "E. OPERACIONES BÁSICAS",
          question: "2/3 × 3/4 =",
          options: { a: "1/2", b: "5/12", c: "6/12", d: "5/7" },
          correct: "a",
          explanation: "6/12, que se simplifica a 1/2",
        },
        // ... (todas las preguntas de la Sección II)
        {
          id: 68,
          section: "II",
          category: "E. OPERACIONES BÁSICAS",
          question: "12 - (-7) =",
          options: { a: "5", b: "-5", c: "19", d: "-19" },
          correct: "c",
          explanation: "12 + 7",
        },
      ];

      // Referencias al DOM
      const welcomeScreen = document.getElementById("welcome-screen");
      const examScreen = document.getElementById("exam-screen");
      const resultsScreen = document.getElementById("results-screen");
      const studentNameInput = document.getElementById("student-name");
      const parentEmailInput = document.getElementById("parent-email");
      const examDateInput = document.getElementById("exam-date");
      const startExamBtn = document.getElementById("start-exam-btn");
      const sectionTitle = document.getElementById("section-title");
      const timerDisplay = document.getElementById("timer");
      const questionsContainer = document.getElementById("questions-container");
      const nextSectionBtn = document.getElementById("next-section-btn");
      const finishExamBtn = document.getElementById("finish-exam-btn");
      const summaryContainer = document.getElementById("summary-container");
      const resultsBreakdown = document.getElementById("results-breakdown");
      const downloadSendBtn = document.getElementById("download-send-btn");
      const printResultsBtn = document.getElementById("print-results-btn");
      const scrollToTopBtn = document.getElementById("scrollToTop");
      const prevPageBtn = document.getElementById("prev-page-btn");
      const nextPageBtn = document.getElementById("next-page-btn");
      const prevPageBtnBottom = document.getElementById("prev-page-btn-bottom");
      const nextPageBtnBottom = document.getElementById("next-page-btn-bottom");
      const paginationInfo = document.getElementById("pagination-info");
      const paginationInfoBottom = document.getElementById(
        "pagination-info-bottom"
      );
      const progressBar = document.getElementById("progress-bar");

      // Botón modal
      const openModalBtn = document.getElementById("openModalBtn");
      const closeModalBtn = document.getElementById("closeModalBtn");
      const modalOverlay = document.getElementById("modalOverlay");
      const modalIframe = document.getElementById("modalIframe");

      // Cargar datos iniciales
      function loadInitialData() {
        const savedAnswers = localStorage.getItem("userAnswers");
        if (savedAnswers) userAnswers = JSON.parse(savedAnswers);

        const savedName = localStorage.getItem("studentName");
        if (savedName) studentNameInput.value = savedName;

        const savedParentEmail = localStorage.getItem("parentEmail");
        if (savedParentEmail) parentEmailInput.value = savedParentEmail;

        // Establecer fecha actual como predeterminada
        const today = new Date().toISOString().split("T")[0];
        examDateInput.value = today;
      }

      // Iniciar examen
      function startExam() {
        const studentName = studentNameInput.value.trim();
        const parentEmail = parentEmailInput.value.trim();

        if (!studentName) {
          alert("Por favor, ingresa tu nombre completo para comenzar.");
          return;
        }

        if (!parentEmail || !/^\S+@\S+\.\S+$/.test(parentEmail)) {
          alert(
            "Por favor, ingresa un correo electrónico válido del padre/encargado."
          );
          return;
        }

        // Guardar información
        localStorage.setItem("studentName", studentName);
        localStorage.setItem("parentEmail", parentEmail);
        localStorage.setItem("examDate", examDateInput.value);

        // Cambiar pantalla
        welcomeScreen.classList.add("hidden");
        examScreen.classList.remove("hidden");

        // Iniciar Sección I
        renderQuestions("I");
        startTimer(60); // 60 minutos para Sección I
      }

      // Obtener preguntas actuales
      function getCurrentSectionQuestions() {
        return examData.filter((q) => q.section === currentSection);
      }

      // Calcular total de páginas
      function getTotalPages() {
        const questions = getCurrentSectionQuestions();
        return Math.ceil(questions.length / questionsPerPage);
      }

      // Obtener preguntas de la página actual
      function getCurrentPageQuestions() {
        const questions = getCurrentSectionQuestions();
        const startIndex = (currentPage - 1) * questionsPerPage;
        const endIndex = startIndex + questionsPerPage;
        return questions.slice(startIndex, endIndex);
      }

      // Actualizar barra de progreso
      function updateProgressBar() {
        const questionsInSection = getCurrentSectionQuestions();
        const answeredCount = questionsInSection.filter(
          (q) => userAnswers[q.id]
        ).length;
        const progress = (answeredCount / questionsInSection.length) * 100;
        progressBar.style.width = `${progress}%`;
      }

      // Actualizar información de paginación
      function updatePaginationInfo() {
        const totalPages = getTotalPages();
        paginationInfo.textContent = `Página ${currentPage} de ${totalPages}`;
        paginationInfoBottom.textContent = `Página ${currentPage} de ${totalPages}`;
      }

      // Actualizar botones de navegación
      function updatePaginationButtons() {
        const totalPages = getTotalPages();
        prevPageBtn.disabled = currentPage === 1;
        prevPageBtnBottom.disabled = currentPage === 1;
        nextPageBtn.disabled = currentPage === totalPages;
        nextPageBtnBottom.disabled = currentPage === totalPages;

        // Mostrar/ocultar botones de sección
        if (currentPage === totalPages) {
          if (currentSection === "I") {
            nextSectionBtn.classList.remove("hidden");
            finishExamBtn.classList.add("hidden");
          } else {
            finishExamBtn.classList.remove("hidden");
            nextSectionBtn.classList.add("hidden");
          }
        } else {
          nextSectionBtn.classList.add("hidden");
          finishExamBtn.classList.add("hidden");
        }
      }

      // Renderizar preguntas
      function renderQuestions(section) {
        currentSection = section;
        currentPage = 1;
        sectionTitle.textContent = `SECCIÓN ${currentSection}`;
        renderCurrentPage();
      }

      // Renderizar página actual
      function renderCurrentPage() {
        questionsContainer.innerHTML = "";
        const questionsToRender = getCurrentPageQuestions();

        // Actualizar barra de progreso
        updateProgressBar();
        updatePaginationInfo();
        updatePaginationButtons();

        questionsToRender.forEach((q) => {
          const questionBlock = document.createElement("div");
          questionBlock.className = "question-block";
          questionBlock.id = `question-${q.id}`;

          let optionsHTML = "";
          for (const key in q.options) {
            const isChecked = userAnswers[q.id] === key ? "checked" : "";
            optionsHTML += `
                        <div class="option">
                            <input type="radio" name="question${
                              q.id
                            }" id="option${
              q.id
            }${key}" value="${key}" ${isChecked}>
                            <label for="option${
                              q.id
                            }${key}"><strong>${key.toUpperCase()})</strong> ${
              q.options[key]
            }</label>
                        </div>`;
          }

          questionBlock.innerHTML = `
                    <p class="question-text"><span class="question-number">${q.id}</span> ${q.question}</p>
                    <div class="options-grid">${optionsHTML}</div>`;
          questionsContainer.appendChild(questionBlock);
        });

        // Agregar event listeners para guardar respuestas
        document.querySelectorAll('input[type="radio"]').forEach((radio) => {
          radio.addEventListener("change", saveProgress);
        });
      }

      // Ir a página
      function goToPage(page) {
        currentPage = page;
        renderCurrentPage();
        window.scrollTo(0, 0);
      }

      // Iniciar temporizador
      function startTimer(minutes) {
        timeRemaining = minutes * 60;
        clearInterval(timerInterval);
        updateTimerDisplay();

        timerInterval = setInterval(() => {
          timeRemaining--;
          updateTimerDisplay();

          if (timeRemaining <= 0) {
            clearInterval(timerInterval);
            alert("El tiempo se ha agotado. El examen se finalizará.");
            finishExam();
          }
        }, 1000);
      }

      // Actualizar display del temporizador
      function updateTimerDisplay() {
        const mins = Math.floor(timeRemaining / 60);
        const secs = timeRemaining % 60;
        timerDisplay.textContent = `${mins.toString().padStart(2, "0")}:${secs
          .toString()
          .padStart(2, "0")}`;

        // Cambiar color cuando quedan 5 minutos
        if (timeRemaining <= 300) {
          timerDisplay.parentElement.style.background =
            "linear-gradient(to right, #ef4444, #dc2626)";
        }
      }

      // Guardar progreso
      function saveProgress() {
        const formData = new FormData(document.getElementById("quiz-form"));
        for (let [key, value] of formData.entries()) {
          const questionId = key.replace("question", "");
          userAnswers[questionId] = value;
        }
        localStorage.setItem("userAnswers", JSON.stringify(userAnswers));
        updateProgressBar();
      }

      // Validar y avanzar
      function validateAndProceed(action) {
        saveProgress();
        const questionsInSection = getCurrentSectionQuestions();
        const unanswered = questionsInSection.filter((q) => !userAnswers[q.id]);

        if (unanswered.length > 0) {
          const unansweredNumbers = unanswered.map((q) => q.id).join(", ");
          if (
            !confirm(
              `Dejaste las siguientes preguntas sin responder: ${unansweredNumbers}. ¿Deseas continuar de todos modos?`
            )
          ) {
            return;
          }
        }
        action();
      }

      // Ir a siguiente sección
      function goToNextSection() {
        currentSection = "II";
        goToPage(1);
        startTimer(30); // 30 minutos para Sección II
        window.scrollTo(0, 0);
      }

      // Finalizar examen
      function finishExam() {
        clearInterval(timerInterval);
        saveProgress();
        examScreen.classList.add("hidden");
        resultsScreen.classList.remove("hidden");
        renderResults();
        scrollToTopBtn.classList.remove("hidden");
      }

      // Mostrar resultados
      function renderResults() {
        const studentName = localStorage.getItem("studentName");
        const parentEmail = localStorage.getItem("parentEmail");
        const examDate = localStorage.getItem("examDate");

        document.getElementById("student-name-result").textContent =
          studentName;
        document.getElementById("parent-email-result").textContent =
          parentEmail;
        document.getElementById("exam-date-result").textContent = examDate;

        let correctCount = 0;
        examData.forEach((q) => {
          if (userAnswers[q.id] === q.correct) correctCount++;
        });

        const totalQuestions = examData.length;
        const percentage =
          totalQuestions > 0
            ? ((correctCount / totalQuestions) * 100).toFixed(2)
            : 0;

        document.getElementById(
          "score"
        ).textContent = `${correctCount} / ${totalQuestions}`;
        document.getElementById("percentage").textContent = `${percentage}%`;

        resultsBreakdown.innerHTML = "<h3>Desglose de Respuestas</h3>";
        examData.forEach((q) => {
          const userAnswer = userAnswers[q.id];
          const isCorrect = userAnswer === q.correct;
          let userAnswerText = "No respondida";
          if (userAnswer)
            userAnswerText = `${userAnswer.toUpperCase()}) ${
              q.options[userAnswer]
            }`;

          const resultItem = document.createElement("div");
          resultItem.className = `result-item ${isCorrect ? "" : "incorrect"}`;
          resultItem.innerHTML = `
                    <p><strong>${q.id}. ${q.question}</strong></p>
                    <p class="user-answer ${
                      isCorrect ? "" : "incorrect-text"
                    }">Tu respuesta: ${userAnswerText}</p>
                    ${
                      !isCorrect
                        ? `
                        <p class="correct-answer-text">Respuesta correcta: ${q.correct.toUpperCase()}) ${
                            q.options[q.correct]
                          }</p>
                        <div class="explanation"><strong>Explicación:</strong> ${
                          q.explanation
                        }</div>
                    `
                        : ""
                    }
                `;
          resultsBreakdown.appendChild(resultItem);
        });
      }

      // Manejar descarga y envío
      function handleDownloadAndSend() {
        const button = downloadSendBtn;
        button.disabled = true;
        button.textContent = "Procesando...";

        try {
          // Descargar PDF
          const summaryContainer = document.getElementById("summary-container");
          const opt = {
            margin: 0.5,
            filename: `Reporte_Resultados_${localStorage
              .getItem("studentName")
              .replace(/ /g, "_")}.pdf`,
            image: { type: "jpeg", quality: 0.98 },
            html2canvas: { scale: 2, useCORS: true },
            jsPDF: { unit: "in", format: "letter", orientation: "portrait" },
          };
          html2pdf().set(opt).from(summaryContainer).save();

          // Enviar por correo
          const studentName = localStorage.getItem("studentName");
          const parentEmail = localStorage.getItem("parentEmail");
          const examDate = localStorage.getItem("examDate");
          const score = document.getElementById("score").textContent;
          const percentage = document.getElementById("percentage").textContent;

          emailjs
            .send("service_6yn0lqe", "template_d3bdnx4", {
              student_name: studentName,
              parent_email_info: parentEmail,
              exam_date: examDate,
              score: score,
              percentage: percentage,
            })
            .then(() => {
              button.innerHTML =
                '<i class="fas fa-check"></i> Enviado correctamente';
              setTimeout(() => {
                button.disabled = false;
                button.innerHTML =
                  '<i class="fas fa-download"></i> Descargar Reporte en PDF y Enviar';
              }, 3000);
            })
            .catch((error) => {
              console.error("Error en el envío:", error);
              button.innerHTML =
                '<i class="fas fa-times"></i> Error en el envío';
              button.disabled = false;
            });
        } catch (error) {
          console.error("Error:", error);
          button.innerHTML =
            '<i class="fas fa-times"></i> Error, intenta de nuevo';
          button.disabled = false;
        }
      }

      // Imprimir resultados
      function printResults() {
        window.print();
      }

      // Subir al inicio
      function scrollToTop() {
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      // Modal functionality
      openModalBtn.addEventListener("click", () => {
        modalOverlay.classList.add("active");
        document.body.style.overflow = "hidden";
      });

      closeModalBtn.addEventListener("click", () => {
        modalOverlay.classList.remove("active");
        document.body.style.overflow = "";
      });

      modalOverlay.addEventListener("click", (e) => {
        if (e.target === modalOverlay) {
          modalOverlay.classList.remove("active");
          document.body.style.overflow = "";
        }
      });

      // Event listeners
      startExamBtn.addEventListener("click", startExam);
      nextSectionBtn.addEventListener("click", () =>
        validateAndProceed(goToNextSection)
      );
      finishExamBtn.addEventListener("click", () =>
        validateAndProceed(finishExam)
      );
      downloadSendBtn.addEventListener("click", handleDownloadAndSend);
      printResultsBtn.addEventListener("click", printResults);
      scrollToTopBtn.addEventListener("click", scrollToTop);

      // Navegación entre páginas
      prevPageBtn.addEventListener("click", () => goToPage(currentPage - 1));
      nextPageBtn.addEventListener("click", () => goToPage(currentPage + 1));
      prevPageBtnBottom.addEventListener("click", () =>
        goToPage(currentPage - 1)
      );
      nextPageBtnBottom.addEventListener("click", () =>
        goToPage(currentPage + 1)
      );

      // Iniciar aplicación
      loadInitialData();
    </script>
  </body>
</html>
